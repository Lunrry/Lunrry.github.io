<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Kubernetes | 明月出天山 苍茫云海间</title><meta name="author" content="桃栀"><meta name="copyright" content="桃栀"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Kubernetes安装快速搭建学习环境minikube curl -LO https:&#x2F;&#x2F;storage.googleapis.com&#x2F;minikube&#x2F;releases&#x2F;latest&#x2F;minikube-linux-amd64 sudo install minikube-linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;minikube minikube start --kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes">
<meta property="og:url" content="https://lunrry.github.io/posts/9acacb00/index.html">
<meta property="og:site_name" content="明月出天山 苍茫云海间">
<meta property="og:description" content="Kubernetes安装快速搭建学习环境minikube curl -LO https:&#x2F;&#x2F;storage.googleapis.com&#x2F;minikube&#x2F;releases&#x2F;latest&#x2F;minikube-linux-amd64 sudo install minikube-linux-amd64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;minikube minikube start --kubernetes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://img.lunrry.top/202307042200081.jpg">
<meta property="article:published_time" content="2023-09-06T02:02:02.000Z">
<meta property="article:modified_time" content="2023-09-25T08:18:44.563Z">
<meta property="article:author" content="桃栀">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://img.lunrry.top/202307042200081.jpg"><link rel="shortcut icon" href="http://img.lunrry.top/202307042155073.png"><link rel="canonical" href="https://lunrry.github.io/posts/9acacb00/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Kubernetes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-25 16:18:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/fontsetting.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="明月出天山 苍茫云海间" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/20230707090308.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://img.lunrry.top/202307042200081.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="明月出天山 苍茫云海间"><img class="site-icon" src="http://img.lunrry.top/202307042143576.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Kubernetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-06T02:02:02.000Z" title="发表于 2023-09-06 10:02:02">2023-09-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-25T08:18:44.563Z" title="更新于 2023-09-25 16:18:44">2023-09-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Kubernetes"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>快速搭建学习环境<code>minikube</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-LO</span> https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
<span class="token function">sudo</span> <span class="token function">install</span> minikube-linux-amd64 /usr/local/bin/minikube
minikube start --kubernetes-version<span class="token operator">=</span>v1.23.3 --image-mirror-country<span class="token operator">=</span><span class="token string">'cn'</span> <span class="token parameter variable">--force</span>
minikube kubectl -- version
<span class="token function">vim</span> <span class="token function">nano</span> ~/.bashrc
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">kubectl</span><span class="token operator">=</span><span class="token string">"minikube kubectl --"</span>
<span class="token builtin class-name">source</span> ~/.bashrc

<span class="token comment"># Minikube Dashboard对外暴露访问链接</span>

kubectl proxy <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">8888</span> <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token string">'192.168.0.4'</span> --accept-hosts<span class="token operator">=</span><span class="token string">'^.*'</span> <span class="token operator">&amp;</span>
http://192.168.0.4:8888/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/<span class="token comment">#/overview?namespace=default</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>Kubernetes 是一个生产级别的容器编排平台和集群管理系统，能够创建、调度容器，监控、管理服务器。</p>
<p><img src="http://img.lunrry.top/img/202309061542907.png" alt="架构图"></p>
<center style="color:#C0C0C0">图1.Kubernetes架构图</center>

<h3 id="Master-里的组件"><a href="#Master-里的组件" class="headerlink" title="Master 里的组件"></a>Master 里的组件</h3><p><img src="http://img.lunrry.top/img/202309061542880.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图2.master组件图</center>

<p><strong>apiserver</strong> 是 Master 节点——同时也是整个 Kubernetes 系统的唯一入口，它对外公开了一系列的 RESTful API，并且加上了验证、授权等功能，所有其他组件都只能和它直接通信，可以说是 Kubernetes 里的联络员。</p>
<p><strong>etcd</strong> 是一个高可用的分布式 Key-Value 数据库，用来持久化存储系统里的各种资源对象和状态，相当于 Kubernetes 里的配置管理员。注意它只与 apiserver 有直接联系，也就是说任何其他组件想要读写 etcd 里的数据都必须经过 apiserver。</p>
<p><strong>scheduler</strong> 负责容器的编排工作，检查节点的资源状态，把 Pod 调度到最适合的节点上运行，相当于部署人员。因为节点状态和 Pod 信息都存储在 etcd 里，所以 scheduler 必须通过 apiserver 才能获得。</p>
<p><strong>controller-manager</strong> 负责维护容器和节点等资源的状态，实现故障检测、服务迁移、应用伸缩等功能，相当于监控运维人员。同样地，它也必须通过 apiserver 获得存储在 etcd 里的信息，才能够实现对资源的各种操作。</p>
<h3 id="Node-里的组件"><a href="#Node-里的组件" class="headerlink" title="Node 里的组件"></a>Node 里的组件</h3><p><img src="http://img.lunrry.top/img/202309061542877.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图3.node组件图</center>

<p><strong>kubelet</strong> 是 Node 的代理，负责管理 Node 相关的绝大部分操作，Node 上只有它能够与 apiserver 通信，实现状态报告、命令下发、启停容器等功能，相当于是 Node 上的一个“小管家”。</p>
<p><strong>kube-proxy</strong> 的作用有点特别，它是 Node 的网络代理，只负责管理容器的网络通信，简单来说就是为 Pod 转发 TCP&#x2F;UDP 数据包，相当于是专职的“小邮差”。</p>
<p><strong>container-runtime</strong> 它是容器和镜像的实际使用者，在 kubelet 的指挥下创建容器，管理 Pod 的生命周期，是真正干活的“苦力”。</p>
<h3 id="Kubernetes工作流程"><a href="#Kubernetes工作流程" class="headerlink" title="Kubernetes工作流程"></a>Kubernetes工作流程</h3><ul>
<li>每个 Node 上的 kubelet 会定期向 apiserver 上报节点状态，apiserver 再存到 etcd 里。</li>
<li>每个 Node 上的 kube-proxy 实现了 TCP&#x2F;UDP 反向代理，让容器对外提供稳定的服务。</li>
<li>scheduler 通过 apiserver 得到当前的节点状态，调度 Pod，然后 apiserver 下发命令给某个 Node 的 kubelet，kubelet 调用 container-runtime 启动容器。</li>
<li>controller-manager 也通过 apiserver 得到实时的节点状态，监控可能的异常情况，再使用相应的手段去调节恢复。</li>
</ul>
<p><img src="http://img.lunrry.top/img/202309061542906.png" alt="img"></p>
<center style="color:#C0C0C0">图4. Kubernetes工作流程图</center>

<h2 id="YAML"><a href="#YAML" class="headerlink" title="YAML"></a><a target="_blank" rel="noopener" href="https://yaml.org/">YAML</a></h2><ul>
<li><p>使用空白与缩进表示层次（有点类似 Python），可以不使用花括号和方括号。</p>
</li>
<li><p>可以使用 # 书写注释，比起 JSON 是很大的改进。</p>
</li>
<li><p>对象（字典）的格式与 JSON 基本相同，但 Key 不需要使用双引号。</p>
</li>
<li><p>数组（列表）是使用 - 开头的清单形式（有点类似 MarkDown）。</p>
</li>
<li><p>表示对象的 : 和表示数组的 - 后面都必须要有空格。</p>
</li>
<li><p>可以使用 — 在一个文件里分隔多个 YAML 对象。</p>
</li>
</ul>
<p><img src="http://img.lunrry.top/img/202309061542055.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图5. YAML语法基础知识点</center>

<h3 id="API对象"><a href="#API对象" class="headerlink" title="API对象"></a>API对象</h3><p>可以使用 <code>kubectl api-resources</code> 来查看当前 Kubernetes 版本支持的所有对象</p>
<p>目前的 Kubernetes 1.23 版本有 50 多种 API 对象，全面地描述了集群的节点、应用、配置、服务、账号等等信息，apiserver 会把它们都存储在数据库 etcd 里，然后 kubelet、scheduler、controller-manager 等组件通过 apiserver 来操作它们，就在 API 对象这个抽象层次实现了对整个集群的管理。</p>
<h3 id="如何描述-API-对象"><a href="#如何描述-API-对象" class="headerlink" title="如何描述 API 对象"></a>如何描述 API 对象</h3><p>首先是API对象的基本信息，有三个字段：apiVersion、kind、metadata</p>
<p><strong>apiVersion</strong> 表示操作这种资源的 API 版本号，由于 Kubernetes 的迭代速度很快，不同的版本创建的对象会有差异，为了区分这些版本就需要使用 apiVersion 这个字段，比如 v1、v1alpha1、v1beta1 等等。</p>
<p><strong>kind</strong> 表示资源对象的类型，这个应该很好理解，比如 Pod、Node、Job、Service 等等。</p>
<p><strong>metadata</strong> 这个字段顾名思义，表示的是资源的一些“元信息”，也就是用来标记对象，方便 Kubernetes 管理的一些信息。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>pod
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span> demo
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> chrono

<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>例：这份 YAML 文档完整地描述了一个类型是 Pod 的 API 对象，要求使用 v1 版本的 API 接口去管理，其他更具体的名称、标签、状态等细节都记录在了 metadata 和 spec 字段等里。</p>
<p>命令 <code>kubectl api-resources</code> 可以查看对象的 apiVersion 和 kind，命令 <code>kubectl explain</code> 可以查看对象字段的说明文档</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl explain pod
kubectl explain pod.metadata
kubectl explain pod.spec
kubectl explain pod.spec.containers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="生成YAML-样板示例"><a href="#生成YAML-样板示例" class="headerlink" title="生成YAML 样板示例"></a>生成YAML 样板示例</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl run ngx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:alpine --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>还可以把这段参数定义成 Shell 变量（名字任意，比如$do&#x2F;$go，这里用的是$out），用起来会更省事，比如：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">out</span><span class="token operator">=</span><span class="token string">"--dry-run=client -o yaml"</span>
kubectl run ngx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:alpine <span class="token variable">$out</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果生成其他 YAML 样板文件的话不能使用 <code>kubectl run</code>，因为 <code>kubectl run</code> 只能创建 Pod，要创建 Pod 以外的其他 API 对象，需要使用命令 <code>kubectl create</code>，再加上对象的类型名。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create job echo-job <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p>Pod 是 Kubernetes 的<code>核心对象</code>，还是应用调度部署的<code>最小单位</code></p>
<p><img src="http://img.lunrry.top/img/202309061542895.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图6. Kubernetes 资源对象关系图</center>

<p>拷贝操作：如我有一个“a.txt”文件，那么就可以使用 <code>kubectl cp</code> 拷贝进 Pod 的“&#x2F;tmp”目录里：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'aaa'</span> <span class="token operator">></span> a.txt
kubectl <span class="token function">cp</span> a.txt ngx-pod:/tmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>进入pod: <code>kubectl exec</code> 的命令格式与 Docker 有一点小差异，需要在 Pod 后面加上 <code>--</code>，把 kubectl 的命令与 Shell 命令分隔开</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> ngx-pod -- <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>准确地说，<code>kubectl cp kubectl exec</code>操作的应该是Pod里的容器，需要用“-c”参数指定容器名，不过因为大多数Pod里只有一个容器，所以就省略了。</p>
</blockquote>
<h2 id="Job-CronJob"><a href="#Job-CronJob" class="headerlink" title="Job&#x2F;CronJob"></a>Job&#x2F;CronJob</h2><h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>先生成一个基本的Job对象</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>job

<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
        <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>job
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/echo"</span><span class="token punctuation">]</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在“spec”字段里，多了一个 <code>template</code> 字段，然后又是一个“spec”</p>
<p><code>template</code> 字段定义了一个“应用模板”，里面嵌入了一个 Pod，这样 Job 就可以从这个模板来创建出 Pod。</p>
<p>而这个 Pod 因为受 Job 的管理控制，不直接和 apiserver 打交道，也就没必要重复 apiVersion 等“头字段”，只需要定义好关键的 <code>spec</code>，描述清楚容器相关的信息就可以了，可以说是一个“无头”的 Pod 对象。</p>
<p><img src="http://img.lunrry.top/img/202309061546451.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图7. Job YAML示意图</center>

<p>由于Job 业务的特殊性，所以我们还要在 <code>spec</code> 里多加一个字段 <code>restartPolicy</code>，确定 Pod 运行失败时的策略，&#96;&#96;OnFailure<code>是失败原地重启容器，而</code>Never&#96; 则是不重启容器，让 Job 去重新调度生成一个新的 Pod。</p>
<h3 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h3><p>使用命令 <code>kubectl create</code> 来创建 CronJob 的样板</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create cj echo-cj <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox <span class="token parameter variable">--schedule</span><span class="token operator">=</span><span class="token string">""</span> --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>cj

<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">'*/1 * * * *'</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">name</span><span class="token punctuation">:</span> echo<span class="token punctuation">-</span>cj
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/echo"</span><span class="token punctuation">]</span>
            <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们还是重点关注它的 <code>spec</code> 字段，你会发现它居然连续有三个 spec 嵌套层次：</p>
<ul>
<li><p>第一个 spec 是 CronJob 自己的对象规格声明</p>
</li>
<li><p>第二个 spec 从属于“jobTemplate”，它定义了一个 Job 对象。</p>
</li>
<li><p>第三个 spec 从属于“template”，它定义了 Job 里运行的 Pod。</p>
</li>
</ul>
<p><img src="http://img.lunrry.top/img/202309061618265.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图7. CronJob YAML示意图</center>

<h2 id="ConfigMap-Secret"><a href="#ConfigMap-Secret" class="headerlink" title="ConfigMap&#x2F;Secret"></a>ConfigMap&#x2F;Secret</h2><p>Kubernetes 里专门用来管理配置信息的两种对象：<code>ConfigMap</code> 和 <code>Secret</code>，使用它们来灵活地配置、定制应用。</p>
<p><strong>ConfigMap</strong>用来保存明文配置</p>
<p><strong>Secret</strong>用来保存秘密配置</p>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>创建一个YAML 样板</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create cm info --from-literal<span class="token operator">=</span>k<span class="token operator">=</span>v --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>因为在 ConfigMap 里的数据都是 <code>Key-Value</code> 结构，所以 &#96;&#96;–from-literal<code>参数需要使用</code>k&#x3D;v&#96; 的形式。</p>
<p>生成的YAML文件如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">k</span><span class="token punctuation">:</span> v
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><ul>
<li>访问私有镜像仓库的认证信息</li>
<li>身份识别的凭证信息</li>
<li>HTTPS通信的证书和私钥</li>
<li>一般的机密信息（格式由用户自行解释）</li>
</ul>
<p>创建一个YAML 样板</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create secret generic user --from-literal<span class="token operator">=</span>name<span class="token operator">=</span>root --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>生成的YAML文件如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cm9vdA==
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ConfigMap-Secret的使用"><a href="#ConfigMap-Secret的使用" class="headerlink" title="ConfigMap&#x2F;Secret的使用"></a>ConfigMap&#x2F;Secret的使用</h3><p>因为 ConfigMap 和 Secret 只是一些存储在 etcd 里的字符串，所以如果想要在运行时产生效果，就必须要以某种方式“注入”到 Pod 里，让应用去读取。<code>环境变量</code>和&#96;&#96;加载文件&#96;</p>
<h4 id="以环境变量方式加载"><a href="#以环境变量方式加载" class="headerlink" title="以环境变量方式加载"></a>以环境变量方式加载</h4><p>YAML样板</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>pod

<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> COUNT
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> info
            <span class="token key atrule">key</span><span class="token punctuation">:</span> count
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GREETING
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> info
            <span class="token key atrule">key</span><span class="token punctuation">:</span> greeting
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> USERNAME
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> user
            <span class="token key atrule">key</span><span class="token punctuation">:</span> name
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PASSWORD
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> user
            <span class="token key atrule">key</span><span class="token punctuation">:</span> pwd

    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> busy
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个 Pod 的名字是“env-pod”，镜像是“busybox”，执行命令 sleep 睡眠 300 秒。</p>
<p><code>env</code>字段里面定义了 4 个环境变量，<code>COUNT</code>、<code>GREETING</code>、<code>USERNAME</code>、<code>PASSWORD</code>。</p>
<p>对于明文配置数据， <code>COUNT、GREETING</code> 引用的是 <code>ConfigMap</code> 对象，所以使用字段<strong>configMapKeyRef</strong>，里面的“name”是 ConfigMap 对象的名字，也就是之前我们创建的“info”，而“key”字段分别是“info”对象里的 <code>count 和 greeting</code>。</p>
<p>对于机密配置数据， <code>USERNAME、PASSWORD</code> 引用的是 <code>Secret</code> 对象，要使用字段“<strong>secretKeyRef</strong>”，再用“name”指定 Secret 对象的名字 user，用“key”字段应用它里面的 <code>name 和 pwd</code> 。</p>
<p>用图解释为：</p>
<p><img src="http://img.lunrry.top/img/202309070945309.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图8.  以环境变量方式加载ConfigMap/Secret示意图</center>

<h4 id="以-Volume-的方式使用-ConfigMap-Secret"><a href="#以-Volume-的方式使用-ConfigMap-Secret" class="headerlink" title="以 Volume 的方式使用 ConfigMap&#x2F;Secret"></a>以 Volume 的方式使用 ConfigMap&#x2F;Secret</h4><p>Kubernetes 为 Pod 定义了一个“Volume”的概念，可以翻译成是“存储卷”，我们可以为 Pod“挂载（mount）”多个 Volume，里面存放供 Pod 访问的数据。</p>
<p>在 Pod 里挂载 Volume 很容易，只需要在“spec”里增加一个“volumes”字段，然后再定义卷的名字和引用的 ConfigMap&#x2F;Secret 就可以了。要注意的是 Volume 属于 Pod，不属于容器，所以它和字段“containers”是同级的，都属于“spec”。</p>
<p>例如：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> info
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sec<span class="token punctuation">-</span>vol
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有了 Volume 的定义之后，就可以在容器里挂载了，这要用到“<strong>volumeMounts</strong>”字段,可以把定义好的 Volume 挂载到容器里的某个路径下，所以需要在里面用“<code>mountPath</code>”“<code>name</code>”明确地指定挂载路径和 Volume 的名字。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/cm<span class="token punctuation">-</span>items
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cm<span class="token punctuation">-</span>vol
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/sec<span class="token punctuation">-</span>items
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sec<span class="token punctuation">-</span>vol<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>把“<strong>volumes</strong>”和“<strong>volumeMounts</strong>”字段都写好之后，配置信息就可以加载成文件了。</p>
<p><img src="http://img.lunrry.top/img/202309070951707.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图9. Volume引用示意图</center>

<h2 id="k8s初级篇思维导图"><a href="#k8s初级篇思维导图" class="headerlink" title="k8s初级篇思维导图"></a>k8s初级篇思维导图</h2><p><img src="http://img.lunrry.top/img/202309071013115.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图10. k8s初级篇思维导图</center>

<h2 id="搭建正式k8s集群"><a href="#搭建正式k8s集群" class="headerlink" title="搭建正式k8s集群"></a>搭建正式k8s集群</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li>修改<code>/etc/hostname</code>文件，如 Master 节点就叫 master，Worker 节点就叫 worker。将主机信息添加到<code>/etc/hosts</code></li>
<li>安装docker</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">DOWNLOAD_URL</span><span class="token operator">=</span><span class="token string">"https://opentuna.cn/docker-ce"</span>
<span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://get.docker.com/ <span class="token operator">|</span> <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="3">
<li>修改Docker配置文件</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json</span>
&#123;
  "registry-mirrors": ["https://bn8vz9h9.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": &#123;
    "max-size": "100m"
  &#125;,
  "storage-driver": "overlay2"
&#125;
EOF</span>

<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>为了让 Kubernetes 能够检查、转发网络流量，你需要修改 iptables 的配置，启用“br_netfilter”模块</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/k8s.conf</span>
br_netfilter
EOF</span>

<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/k8s.conf</span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward=1 # better than modify /etc/sysctl.conf
EOF</span>

<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">--system</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>修改<code>/etc/fstab</code>，关闭 Linux 的 swap 分区，提升 Kubernetes 的性能</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> swapoff <span class="token parameter variable">-a</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'/\sswap\s/s/^#?/#/'</span> /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p><strong>如未特别指定，所有主机都执行</strong></p>
<ol>
<li>更换阿里源</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg 
http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>安装</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.23.3 kubeadm-1.23.3 kubectl-1.23.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>锁定版本避免升级</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-versionlock
yum versionlock <span class="token function">add</span> kubeadm kubelet kubectl
<span class="token comment"># 锁定列表</span>
yum versionlock list
<span class="token comment"># 解除锁定</span>
yum versionlock delete kubeadm kubelet kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>国内环境使用下面方法先拉取镜像</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://www.lunrry.top:99/p/pZySUHXiOb/pull_k8s.sh <span class="token operator">|</span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="5">
<li>初始化</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeadm init --pod-network-cidr<span class="token operator">=</span><span class="token number">10.10</span>.0.0/16 --apiserver-advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.0.4 --kubernetes-version<span class="token operator">=</span>v1.23.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><code>--pod-network-cidr=10.10.0.0/16</code>: 此参数指定了 Pod 网络的 CIDR（Classless Inter-Domain Routing）地址范围。Pod 网络 CIDR 用于分配给 Kubernetes 集群内部的 Pod IP 地址。这个地址范围在您的集群内必须是唯一的。您可以根据需要自定义此地址范围。</li>
<li><code>--apiserver-advertise-address=192.168.10.210</code>: 此参数指定了 API Server（Kubernetes 控制平面的一部分）的地址。它告诉其他节点和组件如何访问 API Server。请将其替换为您主节点的实际 IP 地址。</li>
<li><code>--kubernetes-version=v1.23.3</code>: 此参数指定了要安装的 Kubernetes 版本。在这种情况下，它设置为 v1.23.3 版本。</li>
</ul>
<ol start="6">
<li>保存<code>kubeadm join</code>开头的命令，节点加入集群需要用到，如下：</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.0.4:6443 <span class="token parameter variable">--token</span> 2lz1if.s9teyxxxxxxxxw1 <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:aaa1e19174bee94xxxxxxxxxxxxxxxx3214e5ce492b41f47fd39c56fc84cb2 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="7">
<li>执行</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="8">
<li>配置Flannel网络（master）</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> http://www.lunrry.top:99/p/Ydnp233Q0S/kube-flannel.yml
kubectl apply <span class="token parameter variable">-f</span> kube-flannel.yml
kubectl get <span class="token function">node</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>等待两三分钟，master节点状态变成<code>Ready</code></p>
<ol start="9">
<li>在从节点上运行第<strong>6</strong>点保存的加入集群命令</li>
<li>测试一下</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run ngx --image=nginx:alpine</span>
pod/ngx created
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME   READY   STATUS              RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES
ngx    <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          5s    <span class="token operator">&lt;</span>none<span class="token operator">></span>   worker   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE   IP          NODE     NOMINATED NODE   READINESS GATES
ngx    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27s   <span class="token number">10.10</span>.1.2   worker   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>搭建成功</p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>创建一个Deployment 样板</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create deploy ngx-dep <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:alpine --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create deploy ngx-dep --image=nginx:alpine --dry-run=client -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>dep
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Deployment-的关键字段"><a href="#Deployment-的关键字段" class="headerlink" title="Deployment 的关键字段"></a>Deployment 的关键字段</h3><p><code>replicas</code> 字段。它的含义比较简单明了，就是“副本数量”的意思，指定要在 Kubernetes 集群里运行多少个 Pod 实例。</p>
<p><code>selector</code> 字段。它的作用是“筛选”出要被 Deployment 管理的 Pod 对象，下属字段“<code>matchLabels</code>”定义了 Pod 对象应该携带的 label，它必须和“template”里 Pod 定义的“<code>labels</code>”完全相同，否则 Deployment 就会找不到要控制的 Pod 对象，apiserver 也会告诉你 YAML 格式校验错误无法创建。</p>
<p>因此，为了保证 Deployment 成功创建，我们必须在 YAML 里把 label 重复写两次：一次是在“<code>selector.matchLabels</code>”，另一次是在“<code>template.matadata</code>”</p>
<p>利用下面的图进行理解：</p>
<p><img src="http://img.lunrry.top/img/202309071612189.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图11. Deployment结构图</center>

<h3 id="使用-kubectl-操作-Deployment"><a href="#使用-kubectl-操作-Deployment" class="headerlink" title="使用 kubectl 操作 Deployment"></a>使用 kubectl 操作 Deployment</h3><ol>
<li>部署</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> deploy.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="2">
<li>查看状态</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get deploy
kubectl get pod<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="3">
<li>扩容</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">5</span> deploy ngx-dep<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>要注意， <code>kubectl scale</code> 是命令式操作，扩容和缩容只是临时的措施，如果应用需要长时间保持一个确定的 Pod 数量，最好还是编辑 Deployment 的 YAML 文件，改动“replicas”，再以声明式的 kubectl apply 修改对象的状态。</p>
<h2 id="Daemonset"><a href="#Daemonset" class="headerlink" title="Daemonset"></a>Daemonset</h2><h3 id="为什么要有-DaemonSet"><a href="#为什么要有-DaemonSet" class="headerlink" title="为什么要有 DaemonSet"></a>为什么要有 DaemonSet</h3><p>有一些业务比较特殊，它们不是完全独立于系统运行的，而是与主机存在“绑定”关系，必须要依附于节点才能产生价值，比如说：</p>
<ul>
<li>网络应用（如 kube-proxy），必须每个节点都运行一个 Pod，否则节点就无法加入 Kubernetes 网络。</li>
<li>监控应用（如 Prometheus），必须每个节点都有一个 Pod 用来监控节点的状态，实时上报信息。</li>
<li>日志应用（如 Fluentd），必须在每个节点上运行一个 Pod，才能够搜集容器运行时产生的日志数据。</li>
<li>安全应用，同样的，每个节点都要有一个 Pod 来执行安全审计、入侵检查、漏洞扫描等工作。</li>
</ul>
<p>DaemonSet 的目标是在集群的每个节点上运行且仅运行一个 Pod，就好像是为节点配上一只“看门狗”，忠实地“守护”着节点，这就是 DaemonSet 名字的由来。</p>
<h3 id="如何使用-YAML-描述-DaemonSet"><a href="#如何使用-YAML-描述-DaemonSet" class="headerlink" title="如何使用 YAML 描述 DaemonSet"></a>如何使用 YAML 描述 DaemonSet</h3><p>可以去<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/">Kubernetes 官网</a>找到一份DaemonSet的YAML样板</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> fluentd<span class="token punctuation">-</span>elasticsearch
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> fluentd<span class="token punctuation">-</span>logging
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> fluentd<span class="token punctuation">-</span>elasticsearch
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> fluentd<span class="token punctuation">-</span>elasticsearch
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token comment"># 这些容忍度设置是为了让该守护进程集在控制平面节点上运行</span>
      <span class="token comment"># 如果你不希望自己的控制平面节点运行 Pod，可以删除它们</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/control<span class="token punctuation">-</span>plane
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fluentd<span class="token punctuation">-</span>elasticsearch
        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/fluentd_elasticsearch/fluentd<span class="token punctuation">:</span>v2.5.2
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DaemonSet 仅仅是在 Pod 的部署调度策略上和 Deployment 不同，其他的都是相同的，某种程度上我们也可以把 DaemonSet 看做是 Deployment 的一个特例</p>
<p><img src="http://img.lunrry.top/img/202309071636247.jpeg" alt="img"></p>
<center style="color:#C0C0C0">图11. DaemonSet与Deployment的差异图</center>

<h2 id="污点（taint）和容忍度（toleration）"><a href="#污点（taint）和容忍度（toleration）" class="headerlink" title="污点（taint）和容忍度（toleration）"></a>污点（taint）和容忍度（toleration）</h2><p>Kubernetes 在创建集群的时候会自动给节点 Node 加上一些“污点”，方便 Pod 的调度和部署。例如，可以使用<code>kubectl describe node</code>查看Master 和 Worker 的状态</p>
<p>Master 节点默认有一个 <code>taint</code>，名字是 <code>node-role.kubernetes.io/master</code>，它的效果是 <code>NoSchedule</code>，也就是说这个污点会拒绝 Pod 调度到本节点上运行，而 Worker 节点的 taint 字段则是空的。</p>
<h3 id="去掉taint-添加tolerations"><a href="#去掉taint-添加tolerations" class="headerlink" title="去掉taint&#x2F;添加tolerations"></a>去掉taint&#x2F;添加tolerations</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl taint <span class="token function">node</span> master node-role.kubernetes.io/master:NoSchedule-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这种方法修改的是 Node 的状态，影响面会比较大，可能会导致很多 Pod 都跑到这个节点上运行，所以我们可以保留 Node 的“污点”，为需要的 Pod 添加“容忍度”，只让某些 Pod 运行在个别节点上，实现“精细化”调度。</p>
<p>–</p>
<p>tolerations 是一个数组，里面可以列出多个被“容忍”的“污点”，需要写清楚“污点”的名字、效果。比较特别是要用 operator 字段指定如何匹配“污点”，一般我们都使用 Exists，也就是说存在这个名字和效果的“污点”。</p>
<p>如果我们想让 DaemonSet 里的 Pod 能够在 Master 节点上运行，就要写出这样的一个 tolerations，容忍节点的 node-role.kubernetes.io&#x2F;master:NoSchedule 这个污点：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
  <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>详细可以查看<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/">官方文档</a></p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="http://img.lunrry.top/202307042200081.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/dab9ddeb/" title="一键化脚本"><img class="cover" src="http://img.lunrry.top/202307042200090.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一键化脚本</div></div></a></div><div class="next-post pull-right"><a href="/posts/438ffc78/" title="Dockerfile构建kkFileView应用"><img class="cover" src="http://img.lunrry.top/202307042159200.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dockerfile构建kkFileView应用</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="lv-container" data-id="city" data-uid="MTAyMC81ODY2Ny8zNTEyOQ=="></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/20230707090308.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">桃栀</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">28</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes"><span class="toc-number">1.</span> <span class="toc-text">Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Master-%E9%87%8C%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">Master 里的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-%E9%87%8C%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">Node 里的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">Kubernetes工作流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YAML"><span class="toc-number">1.3.</span> <span class="toc-text">YAML</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.1.</span> <span class="toc-text">API对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8F%8F%E8%BF%B0-API-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.2.</span> <span class="toc-text">如何描述 API 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90YAML-%E6%A0%B7%E6%9D%BF%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">生成YAML 样板示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod"><span class="toc-number">1.4.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Job-CronJob"><span class="toc-number">1.5.</span> <span class="toc-text">Job&#x2F;CronJob</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Job"><span class="toc-number">1.5.1.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CronJob"><span class="toc-number">1.5.2.</span> <span class="toc-text">CronJob</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap-Secret"><span class="toc-number">1.6.</span> <span class="toc-text">ConfigMap&#x2F;Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap"><span class="toc-number">1.6.1.</span> <span class="toc-text">ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Secret"><span class="toc-number">1.6.2.</span> <span class="toc-text">Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap-Secret%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.6.3.</span> <span class="toc-text">ConfigMap&#x2F;Secret的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">以环境变量方式加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A5-Volume-%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8-ConfigMap-Secret"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">以 Volume 的方式使用 ConfigMap&#x2F;Secret</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E5%88%9D%E7%BA%A7%E7%AF%87%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE"><span class="toc-number">1.7.</span> <span class="toc-text">k8s初级篇思维导图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%AD%A3%E5%BC%8Fk8s%E9%9B%86%E7%BE%A4"><span class="toc-number">1.8.</span> <span class="toc-text">搭建正式k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.8.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">1.8.2.</span> <span class="toc-text">安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment"><span class="toc-number">1.9.</span> <span class="toc-text">Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment-%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97%E6%AE%B5"><span class="toc-number">1.9.1.</span> <span class="toc-text">Deployment 的关键字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-kubectl-%E6%93%8D%E4%BD%9C-Deployment"><span class="toc-number">1.9.2.</span> <span class="toc-text">使用 kubectl 操作 Deployment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Daemonset"><span class="toc-number">1.10.</span> <span class="toc-text">Daemonset</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89-DaemonSet"><span class="toc-number">1.10.1.</span> <span class="toc-text">为什么要有 DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-YAML-%E6%8F%8F%E8%BF%B0-DaemonSet"><span class="toc-number">1.10.2.</span> <span class="toc-text">如何使用 YAML 描述 DaemonSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%A1%E7%82%B9%EF%BC%88taint%EF%BC%89%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6%EF%BC%88toleration%EF%BC%89"><span class="toc-number">1.11.</span> <span class="toc-text">污点（taint）和容忍度（toleration）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89taint-%E6%B7%BB%E5%8A%A0tolerations"><span class="toc-number">1.11.1.</span> <span class="toc-text">去掉taint&#x2F;添加tolerations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service"><span class="toc-number">1.12.</span> <span class="toc-text">Service</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/580fd437/" title="ChatGPT403"><img src="http://img.lunrry.top/202307042200090.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ChatGPT403"/></a><div class="content"><a class="title" href="/posts/580fd437/" title="ChatGPT403">ChatGPT403</a><time datetime="2023-11-17T01:11:12.000Z" title="发表于 2023-11-17 09:11:12">2023-11-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dab9ddeb/" title="一键化脚本"><img src="http://img.lunrry.top/202307042200090.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一键化脚本"/></a><div class="content"><a class="title" href="/posts/dab9ddeb/" title="一键化脚本">一键化脚本</a><time datetime="2023-09-14T09:01:07.000Z" title="发表于 2023-09-14 17:01:07">2023-09-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9acacb00/" title="Kubernetes"><img src="http://img.lunrry.top/202307042200081.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kubernetes"/></a><div class="content"><a class="title" href="/posts/9acacb00/" title="Kubernetes">Kubernetes</a><time datetime="2023-09-06T02:02:02.000Z" title="发表于 2023-09-06 10:02:02">2023-09-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/438ffc78/" title="Dockerfile构建kkFileView应用"><img src="http://img.lunrry.top/202307042159200.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dockerfile构建kkFileView应用"/></a><div class="content"><a class="title" href="/posts/438ffc78/" title="Dockerfile构建kkFileView应用">Dockerfile构建kkFileView应用</a><time datetime="2023-08-22T05:54:04.000Z" title="发表于 2023-08-22 13:54:04">2023-08-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d032354a/" title="mysql8常用命令"><img src="http://img.lunrry.top/202307042200081.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql8常用命令"/></a><div class="content"><a class="title" href="/posts/d032354a/" title="mysql8常用命令">mysql8常用命令</a><time datetime="2023-08-17T08:04:07.000Z" title="发表于 2023-08-17 16:04:07">2023-08-17</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By 桃栀</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>function loadLivere () {
  if (typeof LivereTower === 'object') {
    window.LivereTower.init()
  }
  else {
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
  }
}

if ('Livere' === 'Livere' || !false) {
  if (false) btf.loadComment(document.getElementById('lv-container'), loadLivere)
  else loadLivere()
}
else {
  function loadOtherComment () {
    loadLivere()
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>